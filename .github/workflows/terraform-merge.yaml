name: Deploy Terraform Infrastructure

on:
  push:
    branches:
      - qa
      - main
      - prototype

permissions:
  id-token: write
  contents: read

env:
  TF_LOG: INFO

jobs:
  deploy_to_qa:
    env:
      TF_QA_DIRECTORY: -chdir=deployments/environments/qa
    #   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_QA }}
    #   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_QA }}

    if: github.ref == 'refs/heads/prototype'
    name: Deploy to QA
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: AWS Credentials Config
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_QA_GITHUB_ACTIONS }}
        aws-region: eu-central-1

    - name: Terraform Setup
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.7.1

    - name: Terraform fmt
      run: terraform fmt -check -recursive

    - name: Terraform Init
      run:  terraform ${{ env.TF_QA_DIRECTORY }} init

    - name: Terraform Validate
      run: terraform ${{ env.TF_QA_DIRECTORY }} validate -no-color

    - name: Terraform Plan
      run: terraform ${{ env.TF_QA_DIRECTORY }} plan

    - name: Terraform Plan Status
      if: steps.plan.outcome == 'failure'
      run: exit 1

    - name: Terraform Apply
      run: terraform ${{ env.TF_QA_DIRECTORY }} apply -auto-approve -input=false

  # deploy_to_prod:
  #   env:
  #       AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
  #       AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
  #   if: github.ref == 'refs/heads/main'
  #   name: Deploy to Prod
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout Repo
  #     uses: actions/checkout@v3

  #   - name: AWS Credentials Config
  #     uses: aws-actions/configure-aws-credentials@v1
  #     with:
  #       role-to-assume: ${{ secrets.AWS_ROLE_PROD_GITHUB_ACTIONS }}
  #       aws-region: eu-central-1

  #   - name: Terraform Setup
  #     uses: hashicorp/setup-terraform@v3
  #     with:
  #       terraform_version: 1.7.1

  #   - name: Terraform fmt
  #     run: terraform fmt -check

  #   - name: Terraform Init
  #     run:  terraform init

  #   - name: Terraform Validate
  #     run: terraform validate -no-color

  #   - name: Terraform Plan
  #     run: terraform plan

  #   - name: Terraform Plan Status
  #     if: steps.plan.outcome == 'failure'
  #     run: exit 1

  #   - name: Terraform Apply
  #     run: terraform apply -auto-approve -input=false
